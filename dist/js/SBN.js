/*! sbn - v0.0.1 - 2016-06-22 */
$("document").ready(function(){SBN.populateSelect(".noteTimeYear",SBN.__yearList()),SBN.populateSelect(".noteTimeMonth",SBN.__monthList()),SBN.populateSelect(".noteTimeDay",SBN.__dayList(SBN.__yearList()[0].value,SBN.__monthList()[0].value)),SBN.populateSelect(".noteTimeHours",SBN.__hourList()),SBN.populateSelect(".noteTimeMinutes",SBN.__60List()),SBN.populateSelect(".noteTimeSeconds",SBN.__60List()),$("#addNoteModal .noteTimeYear").on("change",function(){var a=this.value,b=$("#addNoteModal .noteTimeMonth").val(),c=$("#addNoteModal .noteTimeDay").val();SBN.populateSelect("#addNoteModal .noteTimeDay",SBN.__dayList(a,b)),$("#addNoteModal .noteTimeDay").val(c)}),$("#addNoteModal .noteTimeMonth").on("change",function(){var a=this.value,b=$("#addNoteModal .noteTimeYear").val(),c=$("#addNoteModal .noteTimeDay").val();SBN.populateSelect("#addNoteModal .noteTimeDay",SBN.__dayList(b,a)),$("#addNoteModal .noteTimeDay").val(c)}),$("#editNoteModal .noteTimeYear").on("change",function(){var a=this.value,b=$("#editNoteModal .noteTimeMonth").val(),c=$("#editNoteModal .noteTimeDay").val();SBN.populateSelect("#editNoteModal .noteTimeDay",SBN.__dayList(a,b)),$("#editNoteModal .noteTimeDay").val(c)}),$("#editNoteModal .noteTimeMonth").on("change",function(){var a=this.value,b=$("#editNoteModal .noteTimeYear").val(),c=$("#editNoteModal .noteTimeDay").val();SBN.populateSelect("#editNoteModal .noteTimeDay",SBN.__dayList(b,a)),$("#editNoteModal .noteTimeDay").val(c)}),$("#addNewBtn").on("click",SBN.showAddNewModal),$("#addNoteModal").on("show.bs.modal",function(){SBN.__config.addNoteModalState=1}),$("#addNoteModal").on("shown.bs.modal",function(){$("#addNoteModal .noteTitle").focus()}),$("#addNoteModal").on("hidden.bs.modal",function(){SBN.__config.addNoteModalState=0}),$("#addNoteModal .createBtn").on("click",SBN.addStickyNote),$("#editNoteModal").on("show.bs.modal",function(){SBN.__config.editNoteModalState=1}),$("#editNoteModal").on("shown.bs.modal",function(){$("#editNoteModal .noteTitle").focus()}),$("#editNoteModal").on("hidden.bs.modal",function(){SBN.__config.editNoteModalState=0}),$("#editNoteModal .updateBtn").on("click",SBN.updateStickyNote),$("#currentTime").on("click",SBN.toggleTimeFormat),$("body").on("keyup",function(a){78===a.which&&0===SBN.__config.addNoteModalState&&0===SBN.__config.editNoteModalState&&SBN.showAddNewModal()}),"Notification"in window&&("granted"===Notification.permission?SBN.__config.notificationsEnabled=!0:"denied"!==Notification.permission&&Notification.requestPermission(function(a){"granted"===a&&(SBN.__config.notificationsEnabled=!0)})),SBN.fetchSBNData(),SBN.renderNotes(),SBN.updateTime(),setInterval(SBN.intervalJobs,1e3)}),SBN={},SBN.data=[],SBN.__config={intervalCount:0,requireSave:!1,deleteStage:{indexId:!1,stage:!1,lastUpdate:!1},addNoteModalState:0,editNoteModalState:0,notificationsEnabled:!1},SBN.config={timeFormat:"24h"},SBN.intervalJobs=function(){SBN.__config.intervalCount++,SBN.__config.intervalCount>3600&&(SBN.__config.intervalCount=0),SBN.updateTime(),SBN.updateCountdownDisplays(),SBN.__config.requireSave&&(SBN.saveSBNData(),SBN.__config.requireSave=!1);var a=new Date,b=!1;for(var c in SBN.data)if("active"===SBN.data[c].reminderStatus){var d=new Date(SBN.data[c].reminderTime);a>=d&&(SBN.data[c].reminderStatus="live",b=!0,SBN.__config.notificationsEnabled&&new Notification(SBN.data[c].title,{body:SBN.data[c].description}))}b&&(SBN.__config.requireSave=!0,SBN.renderNotes()),SBN.__config.intervalCount%10===0&&SBN.__config.deleteStage.lastUpdate&&Date.now()-SBN.__config.deleteStage.lastUpdate>1e4&&(SBN.__config.deleteStage.indexId=!1,SBN.__config.deleteStage.stage=!1,SBN.__config.deleteStage.lastUpdate=!1,SBN.renderNotes())},SBN.updateTime=function(){var a=new Date,b=a.getHours(),c=a.getMinutes(),d=a.getSeconds(),e="";"12h"===SBN.config.timeFormat&&(e=b>=12?" PM":" AM",b>12&&(b-=12),0===b&&(b=12)),b=b<10?"0"+b:b,c=c<10?"0"+c:c,d=d<10?"0"+d:d;var f=b+":"+c+":"+d+e;$("#currentTime").html(f)},SBN.updateCountdownDisplays=function(){var a=new Date;$(".countdown").each(function(b,c){var d=new Date($(c).attr("data-reminderTime")),e="",f=Math.floor((d-a)/1e3);f=f<0?0:f;var g=Math.floor(f/86400);if(g<4){var h=Math.floor(f/3600);f%=3600;var i=Math.floor(f/60);f%=60;var j=f;h=h<10?"0"+h:h,i=i<10?"0"+i:i,j=j<10?"0"+j:j,e=h+":"+i+":"+j}else{var k=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];e=k[d.getMonth()]+" "+d.getDate()+", "+d.getFullYear()}$(c).html(e)})},SBN.showAddNewModal=function(){$("#addNoteModal .noteTitle").val(""),$("#addNoteModal .noteDescription").val("");var a=new Date;$("#addNoteModal .noteTimeYear").val(a.getFullYear()),$("#addNoteModal .noteTimeMonth").val(a.getMonth()+1),$("#addNoteModal .noteTimeDay").val(a.getDate()),$("#addNoteModal .noteTimeHours").val(a.getHours()),$("#addNoteModal .noteTimeMinutes").val(a.getMinutes()),$("#addNoteModal .noteTimeSeconds").val(0),$("#addNoteModal .noteTimeMonth").trigger("change"),$("#addNoteModal").modal("show")},SBN.addStickyNote=function(){var a=$("#addNoteModal .noteTitle").val(),b=$("#addNoteModal .noteDescription").val(),c=$("#addNoteModal .noteTimeYear").val(),d=$("#addNoteModal .noteTimeMonth").val(),e=$("#addNoteModal .noteTimeDay").val(),f=$("#addNoteModal .noteTimeHours").val(),g=$("#addNoteModal .noteTimeMinutes").val(),h=$("#addNoteModal .noteTimeSeconds").val();if(isNaN(c)||isNaN(d)||isNaN(e)||isNaN(f)||isNaN(g)||isNaN(h))return!1;if(c=parseInt(c),d=parseInt(d),e=parseInt(e),f=parseInt(f),g=parseInt(g),h=parseInt(h),a.length>0||b.length>0){var i=new Date(c,d-1,e,f,g,h,0),j=new Date,k="active";j>=i&&(k="done");var l=SBN.findFreeSpace(),m={title:a,description:b,reminderTime:i,reminderStatus:k,left:l.left,top:l.top,zIndex:999};SBN.data.push(m),SBN.__config.requireSave=!0,$("#addNoteModal").modal("hide"),SBN.renderNotes()}},SBN.pinStickyNote=function(){var a=$(this).attr("data-indexId"),b=SBN.data[a];b&&(SBN.data[a].pinned&&SBN.data[a].pinned===!0?SBN.data[a].pinned=!1:SBN.data[a].pinned=!0,SBN.__config.requireSave=!0,SBN.renderNotes())},SBN.deleteStickyNote=function(){var a=$(this).attr("data-indexId");SBN.__config.deleteStage.indexId===a?(SBN.__config.deleteStage.stage===!1?(SBN.__config.deleteStage.stage=0,SBN.__config.deleteStage.lastUpdate=Date.now()):(SBN.__config.deleteStage.stage++,SBN.__config.deleteStage.lastUpdate=Date.now()),SBN.__config.deleteStage.stage>1&&(SBN.data.splice(a,1),SBN.__config.requireSave=!0,SBN.__config.deleteStage.indexId=!1,SBN.__config.deleteStage.stage=!1,SBN.__config.deleteStage.lastUpdate=!1)):(SBN.__config.deleteStage.indexId=a,SBN.__config.deleteStage.stage=0,SBN.__config.deleteStage.lastUpdate=Date.now()),SBN.renderNotes()},SBN.showEditModal=function(a){isNaN(a)&&(a=$(this).attr("data-indexId"));var b=SBN.data[a];if(b){$("#editNoteModal .noteIndexId").val(a),$("#editNoteModal .noteTitle").val(b.title),$("#editNoteModal .noteDescription").val(b.description);var c=new Date(b.reminderTime);$("#editNoteModal .noteTimeYear").val(c.getFullYear()),$("#editNoteModal .noteTimeMonth").val(c.getMonth()+1),$("#editNoteModal .noteTimeDay").val(c.getDate()),$("#editNoteModal .noteTimeHours").val(c.getHours()),$("#editNoteModal .noteTimeMinutes").val(c.getMinutes()),$("#editNoteModal .noteTimeSeconds").val(c.getSeconds()),$("#editNoteModal .noteTimeMonth").trigger("change"),$("#editNoteModal").modal("show")}},SBN.updateStickyNote=function(){var a=$("#editNoteModal .noteIndexId").val(),b=$("#editNoteModal .noteTitle").val(),c=$("#editNoteModal .noteDescription").val(),d=$("#editNoteModal .noteTimeYear").val(),e=$("#editNoteModal .noteTimeMonth").val(),f=$("#editNoteModal .noteTimeDay").val(),g=$("#editNoteModal .noteTimeHours").val(),h=$("#editNoteModal .noteTimeMinutes").val(),i=$("#editNoteModal .noteTimeSeconds").val();if(isNaN(d)||isNaN(e)||isNaN(f)||isNaN(g)||isNaN(h)||isNaN(i))return!1;if(d=parseInt(d),e=parseInt(e),f=parseInt(f),g=parseInt(g),h=parseInt(h),i=parseInt(i),SBN.data[a]&&(b.length>0||c.length>0)){var j=new Date(d,e-1,f,g,h,i,0),k=new Date,l="active";k>=j&&(l="done"),SBN.data[a].title=b,SBN.data[a].description=c,SBN.data[a].reminderTime=j,SBN.data[a].reminderStatus=l,SBN.__config.requireSave=!0,$("#editNoteModal").modal("hide"),SBN.renderNotes()}},SBN.__stickyNoteControls=function(a){var b=$("<div>").addClass("sControls"),c=$("<div>").addClass("leftControls"),d=$("<div>").addClass("centerControls"),e=$("<div>").addClass("rightControls"),f=$("<span>").addClass("glyphicon glyphicon-pushpin text-muted pinNote").attr("data-indexId",a),g=$("<span>"),h=$("<span>").addClass("glyphicon glyphicon-time text-muted reminderControl").attr("data-indexId",a),i=$("<span>").addClass("glyphicon glyphicon-edit text-muted editNote").attr("data-indexId",a),j=$("<span>").addClass("glyphicon glyphicon-remove text-muted deleteNote").attr("data-indexId",a);return SBN.data[a]&&SBN.data[a].pinned&&SBN.data[a].pinned===!0&&f.removeClass("text-muted").addClass("text-success"),!SBN.data[a]||"active"!==SBN.data[a].reminderStatus&&"live"!==SBN.data[a].reminderStatus||(h.removeClass("text-muted").addClass("text-success"),g.addClass("text-muted countdown").attr("data-reminderTime",SBN.data[a].reminderTime)),SBN.__config.deleteStage.indexId===a&&(0===SBN.__config.deleteStage.stage?j.removeClass("text-muted").addClass("text-warning"):1===SBN.__config.deleteStage.stage&&j.removeClass("text-muted").addClass("text-danger")),c.append(f),d.append(g),e.append(h).append(i).append(j),b.append(c).append(d).append(e),b},SBN.__escapeHTML=function(a){if("string"==typeof a){var b="";if(a.length>0)for(var c in a)b+="&"===a[c]?"&amp;":"<"===a[c]?"&lt;":">"===a[c]?"&gt;":a[c];return b}return!1},SBN.__processText=function(a){return"string"==typeof a&&(a=a.replace(new RegExp("\n","g"),"<br>")),a},SBN.__stickyNote=function(a,b){var c=$("<div>").addClass("stickynote"),d=$("<div>").addClass("sTitle"),e=$("<div>").addClass("sDescription");if(d.html(SBN.__escapeHTML(a.title)),e.html(SBN.__processText(SBN.__escapeHTML(a.description))),c.append(d).append(e).append(SBN.__stickyNoteControls(b)),a.pinned&&a.pinned!==!1||c.addClass("draggableStickyNote"),"live"===a.reminderStatus){var f=new Date(a.reminderTime),g=new Date;g>=f&&c.addClass("reminderLive")}return c},SBN.__renderNotePositions=function(){$(".stickynote").each(function(a,b){var c=$(b).position();SBN.data[a].left||(SBN.data[a].left=c.left,SBN.__config.requireSave=!0),SBN.data[a].top||(SBN.data[a].top=c.top,SBN.__config.requireSave=!0);var d={left:SBN.data[a].left,top:SBN.data[a].top,zIndex:SBN.data[a].zIndex?SBN.data[a].zIndex:0},e={left:d.left-c.left,top:d.top-c.top,zIndex:d.zIndex};$(b).css({position:"relative",height:$(b).height(),top:e.top+"px",left:e.left+"px","z-index":e.zIndex})})},SBN.renderNotes=function(){if($("#notesContainer").html(""),SBN.data.length>0){var a=SBN.data;for(var b in a)$("#notesContainer").append(SBN.__stickyNote(a[b],b))}SBN.__renderNotePositions(),$(".draggableStickyNote").draggable({containment:"parent",stack:".stickynote",stop:SBN.saveNotePositions,cancel:".sControls"}),$(".sControls").on("click",".pinNote",SBN.pinStickyNote),$(".sControls").on("click",".reminderControl",SBN.reminderControl),$(".sControls").on("click",".deleteNote",SBN.deleteStickyNote),$(".sControls").on("click",".editNote",SBN.showEditModal)},SBN.saveNotePositions=function(){$(".stickynote").each(function(a,b){SBN.data[a].left=$(b).position().left,SBN.data[a].top=$(b).position().top,SBN.data[a].zIndex=$(b).css("z-index")}),SBN.__config.requireSave=!0},SBN.saveSBNData=function(){"undefined"!=typeof Storage&&(localStorage.setItem("SBNData",JSON.stringify(SBN.data)),localStorage.setItem("SBNConfig",JSON.stringify(SBN.config)))},SBN.fetchSBNData=function(){"undefined"!=typeof Storage&&(localStorage.getItem("SBNData")&&(SBN.data=JSON.parse(localStorage.getItem("SBNData"))),localStorage.getItem("SBNConfig")&&(SBN.config=JSON.parse(localStorage.getItem("SBNConfig"))))},SBN.toggleTimeFormat=function(){"24h"===SBN.config.timeFormat?SBN.config.timeFormat="12h":SBN.config.timeFormat="24h",SBN.__config.requireSave=!0,SBN.updateTime()},SBN.__yearList=function(){for(var a=2016,b=10,c=[],d=a;d<a+b;d++)c.push({value:d,display:d});return c},SBN.__monthList=function(){for(var a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],b=[],c=1;c<=12;c++)b.push({value:c,display:a[c-1]});return b},SBN.__dayList=function(a,b){if(isNaN(a)||isNaN(b))return!1;a=parseInt(a),b=parseInt(b);var c=31,d=[];[4,6,9,11].indexOf(b)>-1&&(c=30),2===b&&(c=28,a%4===0&&(a%100===0?a%400===0&&(c=29):c=29));for(var e=1;e<=c;e++){var f=e<10?"0"+e:e.toString();d.push({value:e,display:f})}return d},SBN.__hourList=function(){for(var a=[],b=0;b<24;b++){var c=b<10?"0"+b:b.toString();a.push({value:b,display:c})}return a},SBN.__60List=function(){for(var a=[],b=0;b<60;b++){var c=b<10?"0"+b:b.toString();a.push({value:b,display:c})}return a},SBN.populateSelect=function(a,b){$(a).html("");for(var c in b){var d=$("<option>");d.val(b[c].value),d.html(b[c].display),$(a).append(d)}return!0},SBN.reminderControl=function(){var a=$(this).attr("data-indexId"),b=SBN.data[a];b&&("done"===b.reminderStatus?SBN.showEditModal(a):"active"!==b.reminderStatus&&"live"!==b.reminderStatus||(SBN.data[a].reminderStatus="done",SBN.__config.requireSave=!0,SBN.renderNotes()))},SBN.__findRenderedNotesPosition=function(){var a=[];return $(".stickynote").each(function(b,c){a.push({x1:$(c).position().left,y1:$(c).position().top,x2:$(c).position().left+$(c).width()+5,y2:$(c).position().top+$(c).height()+5})}),a},SBN.__isEmpty=function(a,b){var c,d=!0;for(var e in b)if(c=b[e],!(a.x2<c.x1||a.x1>c.x2||a.y2<c.y1||a.y1>c.y2)){d=!1;break}return d},SBN.__createGrid=function(a){var b=40,c=60,d=[];d.data=[],d.row_height=(a.y2-a.y1)/b,d.col_width=(a.x2-a.x1)/c;for(var e,f=SBN.__findRenderedNotesPosition(),g=0;g<b;g++){d.data[g]=[];for(var h=0;h<c;h++)e={x1:Math.floor(h*d.col_width+a.x1),y1:Math.floor(g*d.row_height+a.y1),x2:Math.floor(h*d.col_width+a.x1+d.col_width),y2:Math.floor(g*d.row_height+a.y1+d.row_height)},SBN.__isEmpty(e,f)?d.data[g][h]=0:d.data[g][h]=1}return d},SBN.__maximalRectangle=function(a){for(var b=function(a,b,c,d){return c<=a||d<=b?0:(c-a)*(d-b)},c=function(b,c,d,e){for(var f=b;f<=d;f++)for(var g=c;g<=e;g++)if(1===a.data[f][g])return!1;return!0},d=0,e=0,f=0,g=0,h=0;h<a.data.length;h++)for(var i=0;i<=a.data[h].length;i++)for(var j=h;j<a.data.length;j++)for(var k=i;k<a.data[j].length;k++)b(h,i,j,k)>b(d,e,f,g)&&c(h,i,j,k)&&(d=h,e=i,f=j,g=k);return{x1:d,y1:e,x2:f,y2:g}},SBN.findFreeSpace=function(){var a={x1:15,y1:60,x2:$("#notesContainer").width()+15,y2:$("#notesContainer").height()+60},b=SBN.__createGrid(a),c=SBN.__maximalRectangle(b),d={x1:Math.floor(c.y1*b.col_width+a.x1),y1:Math.floor(c.x1*b.row_height+a.y1),x2:Math.floor(c.y2*b.col_width+a.x1),y2:Math.floor(c.x2*b.row_height+a.y1)},e={};return e.left=d.x1,e.top=d.y1,e};